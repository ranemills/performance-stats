"use strict";angular.module("PerformanceDashboard",["angularMoment","ui.router","nvd3"]).constant("JavaHost","").service("QuartersApi",["$http","$q","JavaHost",function(a,b,c){return{get:function(b){return a.get(c+"/api/performances/list",{params:b})},getAvailableFilters:function(b){return a.get(c+"/api/stats/available",{params:b})},getFilters:function(b,d){return a.get(c+"/api/stats/filters",{params:d})}}}]).service("ImportApi",["$http","JavaHost",function(a,b){return{"import":function(c){return a.get(b+"/api/bellboard/import",{params:{bbUrl:c}})}}}]).service("AuthService",["$http","$rootScope","JavaHost",function(a,b,c){var d=function(d,e){var f=d?{authorization:"Basic "+btoa(d.username+":"+d.password)}:{};a.get(c+"/api/auth/user",{headers:f}).then(function(a){b.authenticated=!!a.data.name,e&&e(a.data)},function(){b.authenticated=!1,e&&e()})},e=function(b,d){a.get(c+"/api/auth/register",{params:b}).then(function(){d&&d(!0)},function(){d&&d(!1)})};return{authenticate:d,register:e}}]).config(["$httpProvider","$stateProvider","$urlRouterProvider",function(a,b,c){c.otherwise("/explore"),b.state("explore",{url:"/explore",templateUrl:"views/explore.html",controller:"ExploreController as exploreCtrl"}).state("query",{url:"/query",controller:"QueryController as queryCtrl",templateUrl:"views/query.html"}).state("login",{url:"/login",controller:"LoginController as loginCtrl",templateUrl:"views/login.html"}).state("import",{url:"/import",controller:"ImportController as importCtrl",templateUrl:"views/import.html"}),a.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}]).run(["$rootScope","$state","$http","JavaHost",function(a,b,c,d){a.logout=function(){c.post(d+"/logout",{})["finally"](function(){a.authenticated=!1,b.go("login")})},a.$on("$stateChangeStart",function(c,d,e,f,g,h){a.authenticated||"login"===d.name||(c.preventDefault(),b.go("login"))})}]).controller("LoginController",["$state","$rootScope","AuthService",function(a,b,c){c.authenticate();var d=this;d.credentials={username:"millsy3",password:"password"},d.login=function(){c.authenticate(d.credentials,function(c){b.authenticated?(c.hasImported?a.go("explore"):a.go("import"),d.error=!1):(a.go("login"),d.error=!0)})},d.register=function(){c.register(d.credentials,function(a){d.error=!a,a&&d.login()})}}]).controller("ImportController",["$state","ImportApi",function(a,b){var c=this;c["import"]=function(){b["import"](c.bbUrl).then(function(){a.go("explore")},function(){c.error=!0})}}]).directive("filterSelector",function(){return{restrict:"E",templateUrl:"views/directives/filter-selector.html",scope:{filters:"=filters",onSelectFn:"=onSelect",select:"=selectorObj"},link:function(a){a.activeKey=null,a.onSelect=function(b){a.activeKey=b,a.onSelectFn(b)},a.active=function(b){return a.activeKey===b}}}}).directive("performanceList",function(){return{restrict:"E",templateUrl:"views/directives/performance-list.html",scope:{performances:"="},link:function(a){var b=null;a.expand=function(a){b=b===a?null:a},a.isExpanded=function(a){return b===a}}}}).directive("statsList",function(){return{restrict:"E",templateUrl:"views/directives/stats-list.html",scope:{items:"=",updateFn:"=update",selectorObj:"=selector",selectorKey:"=selectorKey",maxDisplayed:"="},link:function(a){a.active=function(b){return a.selectorObj[a.selectorKey]===b},a.select=function(b){a.active(b)?a.selectorObj[a.selectorKey]=null:a.selectorObj[a.selectorKey]=b,a.updateFn()},a.show=function(b){return _.isNull(a.selectorObj[a.selectorKey])||_.isUndefined(a.selectorObj[a.selectorKey])||a.selectorObj[a.selectorKey]===b},a.increaseMaxDisplayed=function(){a.maxDisplayed=a.maxDisplayed+10}}}}).controller("ExploreController",["$scope","QuartersApi",function(a,b){function c(){b.get(e.select).then(function(a){e.performances=a.data})}function d(){b.getAvailableFilters().then(function(a){e.availableFilters=a.data}),b.getFilters([""],e.select).then(function(a){e.filters=a.data,e.maxDisplayed=_.transform(e.filters,function(a,b,c){return a[c]=10},{}),e.chartsData=_.transform(e.filters,function(a,b,c){a[c]=[{key:c,values:_.take(b,10)}]},{}),e.newFilters=_.transform(e.filters,function(a,b,c){a[c]={},a[c].chartData=[{key:c,values:_.take(b,10)}],a[c].listData=b},{})}),c()}var e=this;e.availableFilters=[],e.select={},e.filters={},e.chartsData={},e.selectFilter=function(a,b){e.select[a]===b?_.unset(e.select,a):_.set(e.select,a,b),d()},e.reset=function(){e.select={},d()},e.reset(),e.state="lists",e.showLists=function(){return"lists"===e.state},e.selectLists=function(){e.state="lists"},e.showCharts=function(){return"charts"===e.state},e.selectCharts=function(){e.state="charts"};var f={chart:{type:"discreteBarChart",height:450,margin:{top:20,right:20,bottom:100,left:55},x:function(a){return a.property},y:function(a){return a.count},showValues:!0,valueFormat:function(a){return d3.format(",d")(a)},xAxis:{rotateLabels:-45},yAxis:{axisLabel:"Count",axisLabelDistance:-10}}};e.chartOptions=function(a){return _.set(f,"chart.discretebar.dispatch.elementClick",function(b){e.selectFilter(a,b.data.label)}),f},e.maxDisplayed={}}]).controller("QueryController",["$scope","$rootScope","QuartersApi",function(a,b,c){function d(){c.getAvailableFilters().then(function(b){a.availableFilters=b.data})}a.performances=[],a.filters={},a.select={},a.availableFilters=[],a.currentFilter=null,a.updatePerformances=function(){c.get(a.select).then(function(b){a.performances=b.data})},a.selectFilter=function(b){a.currentFilter=b;var e=_.omit(a.select,b);c.getFilters([b],e).then(function(b){a.filters=b.data}),d()},a.reset=function(){a.select={},a.updatePerformances(),d()},a.reset()}]),angular.module("PerformanceDashboard").controller("MainCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("webappApp").run(["$templateCache",function(a){a.put("views/directives/filter-dropdown.html",'<div class="panel panel-default"> <div class="panel-heading"> {{ heading }} </div> <div class="panel-body"> <select ng-options="o[itemType] as (o.count + \' \' + o[itemType]) for o in options" ng-model="selected" ng-change="update()"> <option value="">None</option> </select> </div> </div>'),a.put("views/directives/filter-selector.html",'<ul class="list-group"> <a ng-click="onSelect(key)" class="list-group-item" ng-repeat="(key, name) in filters" ng-class="active(key) ? \'active\' : \'\'"> <span class="list-group-item-heading">{{name}}</span> <span class="list-group-item-text pull-right text-muted">{{select[key] || \'None\'}}</span> </a> </ul>'),a.put("views/directives/performance-list.html",'<table class="table table-striped table-bordered"> <tr> <th>Date</th> <th>Changes</th> <th>Method</th> <th>Stage</th> <th>Location</th> </tr> <tr ng-repeat-start="quarter in performances" ng-click="expand($index)"> <td>{{quarter.date | amParse: \'DD-MM-YYYY\' | amDateFormat: \'Do MMMM YYYY\' }}</td> <td>{{quarter.changes}}</td> <td>{{quarter.method}}</td> <td>{{quarter.stage}}</td> <td>{{quarter.location.name}}</td> </tr> <tr ng-repeat-end ng-show="isExpanded($index)"> <td colspan="5" class=""> <div class="col col-xs-2"></div> <div class="col col-xs-8"> <p>{{quarter.location.name}}</p> <p>{{quarter.date | amParse: \'DD-MM-YYYY\' | amDateFormat: \'dddd Do MMMM YYYY\' }}</p> <p>{{quarter.changes}} {{quarter.method}} {{quarter.stage}}</p> <ol> <li ng-repeat="ringer in quarter.ringers | orderBy: ringer.methodBell"> {{ringer.name}} </li> </ol> </div> <div class="col col-xs-2"></div> </td> </tr> </table>'),a.put("views/directives/stats-list.html",'<div class="panel panel-body"> <div class="input-group"> <span class="input-group-addon" id="basic-addon1">@</span> <input type="text" class="form-control" placeholder="Search..." ng-model="searchText"> </div> </div> <ul class="list-group"> <a class="list-group-item" ng-repeat="item in items | filter: searchText | orderBy: item.count | limitTo: maxDisplayed" ng-click="select(item.property)" ng-class="active(item.property) ? \'active\' : \'\'" ng-if="show(item.property)"> <span class="badge">{{item.count}}</span> {{item.property}} </a> <a class="list-group-item" ng-if="items.length > maxDisplayed" ng-click="increaseMaxDisplayed()">Show more...</a> </ul>'),a.put("views/explore.html",'<div class="panel panel-default has-inner-drawer"> <div class="panel-heading"> <h4>Explore</h4> </div> <div class="panel-body"> <div class="drawer drawer-right drawer-inside dw-xs-5 fold" id="performanceDrawer"> <div class="drawer-contents"> <div class="drawer-heading"> <button type="button" class="btn btn-default navbar-btn" href="#performanceDrawer" data-toggle="drawer" aria-foldedopen="false" aria-controls="performanceDrawer"> Hide Performances </button> </div> <performance-list performances="exploreCtrl.performances"></performance-list> </div> </div> <nav class="navbar navbar-default"> <div class="container-fluid"> <div class="collapse navbar-collapse"> <ul class="nav navbar-nav navbar-right"> <li> <button type="button" class="btn btn-default navbar-btn" href="#performanceDrawer" data-toggle="drawer" aria-foldedopen="false" aria-controls="performanceDrawer"> Show Performances </button> <button type="button" class="btn btn-default navbar-btn" ng-click="exploreCtrl.reset()"> Reset </button> </li> </ul> </div> </div> </nav> <div class="row"> <div class="col col-xs-3" ng-repeat="(filterName, filterObj) in exploreCtrl.newFilters" ng-init="exploreCtrl.view[$index] = \'chart\'"> <div class="panel panel-default"> <div class="panel-heading"> <div class="row"> <span class="pull-left col col-xs-8">{{ filterName }}</span> <span class="pull-right col col-xs-4"> <button class="btn btn-default" ng-click="exploreCtrl.view[$index] = \'chart\'"> <i class="glyphicon glyphicon-stats"></i> </button> <button class="btn btn-default" ng-click="exploreCtrl.view[$index] = \'list\'"> <i class="glyphicon glyphicon-list"></i> </button> </span> </div> </div> <div class="panel-body"> <stats-list ng-if="exploreCtrl.view[$index] === \'list\'" items="filterObj.listData" selector="exploreCtrl.select" max-displayed="exploreCtrl.maxDisplayed[filterName]" selector-key="filterName" update="exploreCtrl.selectFilter"> </stats-list> <nvd3 ng-if="exploreCtrl.view[$index] === \'chart\'" options="exploreCtrl.chartOptions(filterName)" data="filterObj.chartData"></nvd3> </div> </div> </div> </div> <div class="row"> <div class="col col-xs-12"> <div class="panel panel-body panel-default"> <performance-list performances="exploreCtrl.performances"></performance-list> </div> </div> </div> </div> </div>'),a.put("views/import.html",'<div class="panel panel-body"> <div class="row"> <div class="col col-xs-12"> Please enter the <a href="http://bb.ringingworld.co.uk/search.php" target="_blank">BellBoard</a> search for the performances which you would like to explore. (Note: handbell performances are not supported) E.g. <div class="well well-sm"> http://bb.ringingworld.co.uk/search.php?ringer=ryan+mills&length=peal&bells_type=tower </div> </div> </div> <div class="row"> <div class="col col-xs-12"> <form role="form" ng-submit="importCtrl.import()"> <div class="input-group"> <span class="input-group-addon" id="basic-addon1">Bellboard Search URL</span> <input type="text" class="form-control" id="bbUrl" name="bbUrl" ng-model="importCtrl.bbUrl"> <span class="input-group-btn"> <button class="btn btn-default" type="submit">Go!</button> </span> </div> </form> </div> </div> <div class="row"> <div class="col col-xs-12"> <div class="alert alert-danger" ng-show="importCtrl.error"> There was a problem importing. Please check that you\'re using a valid BellBoard search URL. </div> </div> </div> </div>'),a.put("views/login.html",'<div class="panel panel-body"> <div class="row"> <div class="col col-xs-12"> <div class="alert alert-danger" ng-show="loginCtrl.error"> There was a problem logging in. Please try again. </div> <form role="form" ng-submit=""> <div class="form-group"> <label for="username">Username:</label> <input type="text" class="form-control" id="username" name="username" ng-model="loginCtrl.credentials.username"> </div> <div class="form-group"> <label for="password">Password:</label> <input type="password" class="form-control" id="password" name="password" ng-model="loginCtrl.credentials.password"> </div> <button type="button" ng-click="loginCtrl.login()" class="btn btn-primary">Submit</button> <button type="button" ng-click="loginCtrl.register()" class="btn btn-default">Register</button> </form> </div> </div> </div>'),a.put("views/query.html",'<nav class="navbar navbar-default"> <div class="container-fluid"> <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1"> <ul class="nav navbar-nav navbar-right"> <li> <button type="button" class="btn btn-default navbar-btn" ng-click="reset()">Reset</button> </li> </ul> </div> </div> </nav> <div class="panel panel-default"> <!--<div class="panel-heading">--> <!--</div>--> <div class="panel-body"> <div class="row"> <div class="col-xs-2 pull-right"> <button class="btn btn-primary" ng-click="reset()">Reset</button> </div> </div> <div class="row"> <div class="col col-xs-3"> <filter-selector filters="availableFilters" on-select="selectFilter" selector-obj="select"></filter-selector> </div> <div class="col col-xs-3"> <stats-list ng-if="currentFilter" items="filters[currentFilter]" selector="select" selector-key="currentFilter" update="updatePerformances"></stats-list> </div> <div class="col col-xs-6"> <ul class="nav nav-tabs"> <li class="active"><a href="#">Performances</a></li> <li><a href="#">Charts</a></li> </ul> <div ng-if="true"> <!-- TODO: Only show if the Performances tab is selected--> <performance-list performances="performances"></performance-list> </div> </div> </div> </div> </div> ')}]);